<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Termin buchen</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--brand:#2ec4b6;--brand-600:#26a79b;--bg:#0b0c0f;--card:#15181c;--text:#e8edf2;--muted:#9aa3ad;--danger:#ff5c5c}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,Segoe UI,Arial;display:grid;place-items:start center;min-height:100svh}
.wrap{width:min(1100px,100%);padding:24px}

/* Header */
.header{
  display:grid;
  grid-template-columns:1fr auto 1fr;   /* Mitte = Navigation */
  align-items:center; gap:12px; margin-bottom:12px;
}
.nav-core{
  grid-column:2;                         /* in die Mitte */
  justify-self:center;
  display:flex; align-items:center; gap:12px;
}
.controls{
  grid-column:3;                         /* rechts */
  justify-self:end;
}
.btn{border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:600;border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--text)}
.btn.icon{width:40px;height:40px;display:grid;place-items:center;font-size:18px;border-radius:10px}
.btn.primary{background:var(--brand);border:none;color:#0b0c0f}
.btn.primary:hover{background:var(--brand-600)}
.datepick{appearance:none;background:#0f1215;border:1px solid rgba(255,255,255,.18);color:var(--text);padding:8px 10px;border-radius:10px;font:inherit}

/* Shell */
.card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
.clock{color:var(--muted);text-align:center;margin-bottom:12px;font-variant-numeric:tabular-nums}

/* Collapsible */
.collapsible{overflow:hidden;max-height:0;transition:max-height .35s ease}
.collapsible.open{max-height:2000px}

/* Desktop-Kalender */
.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:14px}
.day{display:flex;flex-direction:column;gap:10px;min-width:140px}
.head{display:grid;align-content:center;justify-items:center;gap:4px;height:64px;text-align:center}
.dnum{font-weight:600;display:inline-grid;place-items:center;min-width:3ch}
.dow{color:var(--muted);font-size:12px;white-space:nowrap}
.today .dnum{background:rgba(255,255,255,.1);padding:3px 10px;border-radius:999px}
.slots{display:grid;grid-auto-rows:44px;gap:10px;position:relative}
.slot{height:44px;display:grid;place-items:center;border-radius:14px;border:1px dashed transparent;background:var(--brand);color:#0b0c0f;font-weight:600;font-variant-numeric:tabular-nums;cursor:pointer}
.slot:hover{background:var(--brand-600)}
.slot.selected{outline:2px solid #fff}
.slot.unavailable{background:transparent;border-color:rgba(255,255,255,.2);color:var(--muted);text-decoration:line-through;cursor:not-allowed}
.now-line{position:absolute;left:0;right:0;height:2px;background:var(--danger);box-shadow:0 0 0 2px rgba(255,92,92,.15)}
.now-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--danger);left:-6px;transform:translateY(-4px)}

/* Formular */
.form-block{display:none;margin-top:16px}
.form-block.show{display:block}
.form{
  display:grid;
  grid-template-columns:repeat(2,minmax(260px,1fr));
  column-gap:16px; row-gap:14px
}
.form .full{grid-column:1/-1}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0f1215;color:var(--text)}
.inline{display:grid;grid-template-columns:140px 1fr;gap:10px}

/* Terms */
.terms{display:grid;gap:10px}
.terms .summary{margin:0;font-size:13px;line-height:1.55;color:var(--muted)}
.terms .accept{margin:0;display:flex;align-items:center;justify-content:flex-end;gap:10px;font-weight:600}
.terms .accept input{inline-size:18px;block-size:18px;margin:0}
.terms .accept.invalid{outline:2px solid var(--danger);border-radius:8px;padding:.25rem .5rem}
.hint{color:var(--muted);font-size:13px;margin-top:6px}
.ok{color:#3ddc97}.err{color:#ff6b6b}

/* Mobile */
.mobile{display:none}
@media (max-width:720px){
  .grid{display:none}
  .mobile{display:grid;gap:12px}
  .date-strip{display:grid;grid-auto-flow:column;grid-auto-columns:min(22vw,92px);gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:4px 2px}
  .date-btn{scroll-snap-align:center;display:grid;gap:4px;justify-items:center;padding:10px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#0f1215;color:var(--text);cursor:pointer}
  .date-btn .dn{font-weight:600}.date-btn .dw{font-size:12px;color:var(--muted)}
  .date-btn.active{outline:2px solid var(--brand);border-color:transparent}
  .mobile-slots{display:grid;grid-auto-rows:44px;gap:8px;position:relative}
  .slot{height:44px;border-radius:12px}
  .form{grid-template-columns:1fr}
  .inline{grid-template-columns:1fr 1fr}
}

/* Hide-on-toggle */
.calendar-hidden .nav-core,
.calendar-hidden #clock,
.calendar-hidden #calWrap,
.calendar-hidden .mobile,
.calendar-hidden .form-block{display:none!important}

/* Floating Confirm */
.confirm-bar{
  position:fixed;left:0;right:0;bottom:0;z-index:50;display:none;
  background:rgba(21,24,28,.92);border-top:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(6px);padding:12px 16px
}
.confirm-bar.show{display:block}
.confirm-bar .btn{width:100%;height:48px;font-weight:700;border-radius:12px}
.calendar-hidden .confirm-bar{display:none!important}
</style>
</head>
<body>
<noscript style="color:#fff;padding:8px">JavaScript erforderlich.</noscript>

<div class="wrap">
  <div class="header">
    <div class="nav-core">
      <button id="prev" class="btn icon" aria-label="Vorherige Woche">â—€</button>
      <input id="jumpDate" class="datepick" type="date" aria-label="Datum auswÃ¤hlen">
      <button id="next" class="btn icon" aria-label="NÃ¤chste Woche">â–¶</button>
    </div>
    <div class="controls">
      <button id="toggle" class="btn" aria-expanded="true">Kalender verbergen</button>
    </div>
  </div>

  <div class="card">
    <div id="clock" class="clock">â€”:â€”</div>

    <!-- Desktop -->
    <div id="calWrap" class="collapsible open">
      <div class="grid" id="grid"></div>
    </div>

    <!-- Mobile -->
    <div class="mobile">
      <div class="date-strip" id="dateStrip"></div>
      <div class="mobile-slots" id="mSlots"></div>
    </div>

    <!-- Formular -->
    <div class="form-block" id="formBlock">
      <form id="form" class="form" novalidate>
        <div>
          <label for="first">Vorname</label>
          <input id="first" name="first" autocomplete="given-name" required>
        </div>
        <div>
          <label for="last">Nachname</label>
          <input id="last" name="last" autocomplete="family-name" required>
        </div>
        <div>
          <label for="gender">Geschlecht</label>
          <select id="gender" name="gender" required>
            <option value="" selected>Bitte auswÃ¤hlen</option>
            <option>Weiblich</option>
            <option>MÃ¤nnlich</option>
            <option>Divers</option>
            <option>Keine Angabe</option>
          </select>
        </div>
        <div>
          <label for="dob">Geburtsdatum</label>
          <input id="dob" name="dob" type="date" required>
        </div>
        <div class="full">
          <label for="email">E-Mail</label>
          <input id="email" name="email" type="email" autocomplete="email" required>
        </div>
        <div class="full">
          <label>Mobilnummer</label>
          <div class="inline">
            <select id="cc" name="cc">
              <option value="+352">ðŸ‡±ðŸ‡º +352</option>
              <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
              <option value="+33">ðŸ‡«ðŸ‡· +33</option>
              <option value="+32">ðŸ‡§ðŸ‡ª +32</option>
            </select>
            <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="628 123 456" required>
          </div>
        </div>

        <div class="full terms">
          <p class="summary">
            Kurzfassung: Der Termin kann vom Anbieter aus organisatorischen GrÃ¼nden
            verschoben oder storniert werden. Sie werden per E-Mail oder SMS informiert.
            Mit dem Absenden stimmen Sie der Kontaktaufnahme zu.
          </p>
          <label class="accept" id="termsLabel">
            Ich akzeptiere die Bedingungen.
            <input id="terms" type="checkbox" required>
          </label>
        </div>

        <div id="msg" class="full hint" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>
</div>

<!-- Floating Confirm -->
<div id="confirmBar" class="confirm-bar">
  <button id="confirmBtn" class="btn primary" type="button">Weiter</button>
</div>

<script>
(()=>{
// Config
const SLOT_MIN=30, START="08:00", END="17:00", LOCALE="de-DE";

// State
let weekOffset=0, selectedTs=null, mobileDayTs=null;
const booked=new Set();

// DOM
const grid=document.getElementById("grid");
const mStrip=document.getElementById("dateStrip");
const mSlots=document.getElementById("mSlots");
const clock=document.getElementById("clock");
const prev=document.getElementById("prev");
const next=document.getElementById("next");
const toggle=document.getElementById("toggle");
const calWrap=document.getElementById("calWrap");
const form=document.getElementById("form");
const msg=document.getElementById("msg");
const jumpDate=document.getElementById("jumpDate");
const formBlock=document.getElementById("formBlock");
const confirmBar=document.getElementById("confirmBar");
const confirmBtn=document.getElementById("confirmBtn");
const termsBox=document.getElementById("terms");
const termsLabel=document.getElementById("termsLabel");

// Utils
const toMin=s=>{const[a,b]=s.split(':').map(Number);return a*60+b;}
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}
const startOfWeek=d=>{const x=new Date(d);const w=(x.getDay()+6)%7;x.setDate(x.getDate()-w);x.setHours(0,0,0,0);return x;}
const times=(a,b,step)=>{const out=[];for(let m=toMin(a);m<toMin(b);m+=step){out.push(`${String(m/60|0).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`)}return out;}
const tsFor=(date,hm)=>{const[h,m]=hm.split(':').map(Number);const x=new Date(date);x.setHours(h,m,0,0);return x.getTime()}

// Load booked from backend
async function loadBooked(){
  try{
    const r=await fetch('/api/slots',{cache:'no-store'});
    if(!r.ok) throw new Error('Server');
    const js=await r.json();
    booked.clear();
    (js.data||[]).forEach(s=>{
      if(s.startISO) booked.add(new Date(s.startISO).getTime());
    });
    return true;
  }catch{
    // Nicht erreichbar -> Meldung, weiter rendern ohne Buchungen
    msg.innerHTML='<span class="err">Technische StÃ¶rung: Server/DB nicht erreichbar.</span>';
    return false;
  }
}

// Controls
prev.onclick =()=>{weekOffset--; renderAll()}
next.onclick =()=>{weekOffset++; renderAll()}
toggle.onclick=()=>{const hide=document.body.classList.toggle('calendar-hidden');toggle.setAttribute('aria-expanded',String(!hide));calWrap.classList.toggle('open',!hide);if(hide){confirmBar.classList.remove('show');}}
jumpDate.value=new Date().toISOString().slice(0,10);
jumpDate.onchange=()=>{if(!jumpDate.value) return;const base=startOfWeek(new Date());const target=startOfWeek(new Date(jumpDate.value));const diffDays=Math.round((target-base)/86400000);weekOffset=Math.trunc(diffDays/7);mobileDayTs=target.getTime();renderAll();}

function tick(){clock.textContent=new Date().toLocaleString(LOCALE,{weekday:'short',day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}

// Desktop render
function renderDesktop(){
  grid.innerHTML='';
  const now=Date.now(), base=startOfWeek(new Date()), weekStart=addDays(base,weekOffset*7);
  const tlist=times(START,END,SLOT_MIN);
  for(let i=0;i<7;i++){
    const day=addDays(weekStart,i), isToday=day.toDateString()===(new Date()).toDateString();
    const col=document.createElement('div'); col.className='day'+(isToday?' today':'');
    const head=document.createElement('div'); head.className='head';
    head.innerHTML=`<div class="dnum">${day.toLocaleDateString(LOCALE,{day:'2-digit'})}</div><div class="dow">${day.toLocaleDateString(LOCALE,{weekday:'short'})}${isToday?' â€¢ heute':''}</div>`;
    const list=document.createElement('div'); list.className='slots';
    col.append(head,list);
    for(const t of tlist){
      const ts=tsFor(day,t), inPast=ts<now, isBooked=booked.has(ts);
      const btn=document.createElement('button'); btn.type='button'; btn.textContent=t; btn.className='slot';
      if(selectedTs===ts) btn.classList.add('selected');
      if(inPast||isBooked){btn.disabled=true;btn.classList.add('unavailable')}
      btn.onclick=()=>selectSlot(ts,btn);
      list.appendChild(btn);
    }
    if(isToday) requestAnimationFrame(()=>positionNowLine(list));
    grid.appendChild(col);
  }
}

// Mobile render
function renderMobile(){
  mStrip.innerHTML=''; mSlots.innerHTML='';
  const base=startOfWeek(new Date()), weekStart=addDays(base,weekOffset*7);
  const now=Date.now(), tlist=times(START,END,SLOT_MIN);
  for(let i=0;i<7;i++){
    const day=addDays(weekStart,i), isToday=day.toDateString()===(new Date()).toDateString();
    const b=document.createElement('button'); b.type='button'; b.className='date-btn';
    b.innerHTML=`<div class="dn">${day.toLocaleDateString(LOCALE,{day:'2-digit'})}</div><div class="dw">${day.toLocaleDateString(LOCALE,{weekday:'short'})}${isToday?' â€¢ heute':''}</div>`;
    b.onclick=()=>{[...mStrip.children].forEach(x=>x.classList.remove('active'));b.classList.add('active');mobileDayTs=day.getTime();renderMobileSlots(day,tlist,now)}
    if((mobileDayTs==null&&isToday)||(mobileDayTs&&new Date(mobileDayTs).toDateString()===day.toDateString())) b.classList.add('active');
    mStrip.appendChild(b);
  }
  renderMobileSlots(new Date(mobileDayTs??weekStart),tlist,now);
}
function renderMobileSlots(day,tlist,now){
  mSlots.innerHTML='';
  for(const t of tlist){
    const ts=tsFor(day,t), btn=document.createElement('button'); btn.type='button'; btn.textContent=t; btn.className='slot';
    const inPast=ts<now, isBooked=booked.has(ts);
    if(selectedTs===ts) btn.classList.add('selected');
    if(inPast||isBooked){btn.disabled=true;btn.classList.add('unavailable')}
    btn.onclick=()=>selectSlot(ts,btn);
    mSlots.appendChild(btn);
  }
  const isToday=(new Date(day)).toDateString()===(new Date()).toDateString();
  if(isToday) requestAnimationFrame(()=>positionNowLine(mSlots));
  else mSlots.querySelectorAll('.now-line,.now-dot').forEach(n=>n.remove());
}

// Helpers
function positionNowLine(container){
  const s=toMin(START), e=toMin(END), now=new Date(), m=now.getHours()*60+now.getMinutes();
  if(m<s||m>e){container.querySelectorAll('.now-line,.now-dot').forEach(n=>n.remove());return;}
  const y=((m-s)/(e-s))*(container.scrollHeight-2);
  let l=container.querySelector('.now-line'), d=container.querySelector('.now-dot');
  if(!l){l=document.createElement('div');l.className='now-line';container.appendChild(l)}
  if(!d){d=document.createElement('div');d.className='now-dot';container.appendChild(d)}
  l.style.top=`${y}px`; d.style.top=`${y}px`;
}

function selectSlot(ts,btn){
  document.querySelectorAll('.slot.selected').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected'); selectedTs=ts;
  const when=new Date(ts);
  msg.innerHTML=`AusgewÃ¤hlt: <span class="ok">${when.toLocaleString(LOCALE,{weekday:'short',day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>`;
  confirmBtn.textContent='Weiter';
  confirmBtn.dataset.state='preview';
  confirmBar.classList.add('show');
}

// Confirm bar
confirmBtn.onclick = () => {
  if(confirmBtn.dataset.state === 'preview'){
    formBlock.classList.add('show');
    confirmBtn.textContent='Termin bestÃ¤tigen';
    confirmBtn.dataset.state='submit';
    formBlock.scrollIntoView({behavior:'smooth',block:'start'});
  }else{
    form.requestSubmit();
  }
};

// Render
function isMobile(){return matchMedia('(max-width: 720px)').matches}
async function renderAll(){
  await loadBooked();
  tick();
  if(isMobile()) renderMobile(); else renderDesktop();
}
function tick(){clock.textContent=new Date().toLocaleString(LOCALE,{weekday:'short',day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}

// Checkbox live-Markierung beim â€žWeiterâ€œ
function markTermsInvalid(on){
  termsLabel.classList.toggle('invalid', !!on);
  termsBox.setAttribute('aria-invalid', on ? 'true' : 'false');
}

// Form submit
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); msg.textContent='';
  markTermsInvalid(false);

  if(selectedTs==null){msg.innerHTML='<span class="err">Bitte erst einen Termin wÃ¤hlen.</span>';return;}
  const f=form;

  const payload = {
    firstName: f.first.value.trim(),
    lastName:  f.last.value.trim(),
    email:     f.email.value.trim(),
    gender:    f.gender.value,
    phone:     f.phone.value.trim(),
    countryCode: f.cc.value,
    birthDate: f.dob.value,
    startISO:  new Date(selectedTs).toISOString(),
    endISO:    new Date(selectedTs + SLOT_MIN*60000).toISOString(),
    taken:     true
  };

  if(!payload.firstName || !payload.lastName){msg.innerHTML='<span class="err">Vor- und Nachname angeben.</span>';return;}
  if(!payload.gender){msg.innerHTML='<span class="err">Geschlecht wÃ¤hlen.</span>';return;}
  if(!payload.birthDate){msg.innerHTML='<span class="err">Geburtsdatum angeben.</span>';return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)){msg.innerHTML='<span class="err">E-Mail ungÃ¼ltig.</span>';return;}
  if(!/\d{3,}/.test(payload.phone)){msg.innerHTML='<span class="err">Mobilnummer prÃ¼fen.</span>';return;}
  if(!termsBox.checked){
    markTermsInvalid(true);
    msg.innerHTML='<span class="err">Bitte Bedingungen akzeptieren.</span>';
    termsBox.focus();
    return;
  }

  try {
    const r = await fetch('/api/book', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const js = await r.json().catch(()=>({ok:false,error:'Server'}));
    if(!r.ok || !js.ok) throw new Error(js.error || 'Technische StÃ¶rung â€“ bitte spÃ¤ter versuchen.');

    msg.innerHTML='<span class="ok">Termin bestÃ¤tigt. BestÃ¤tigung folgt per E-Mail/SMS.</span>';
    f.reset(); confirmBar.classList.remove('show'); formBlock.classList.remove('show');
    await loadBooked(); selectedTs=null; renderAll();
  } catch(err){
    msg.innerHTML='<span class="err">'+(err.message||'Technische StÃ¶rung â€“ bitte spÃ¤ter versuchen.')+'</span>';
  }
});

// Init
tick(); renderAll();
setInterval(()=>{tick();}, 30000);
addEventListener('resize', renderAll);

// Live: Checkbox Fehlerrahmen zurÃ¼cknehmen
termsBox.addEventListener('change', ()=> markTermsInvalid(!termsBox.checked));
})();
</script>
</body>
</html>
