<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Termin buchen</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#2ec4b6; --brand-600:#26a79b;
    --bg:#0b0c0f; --card:#15181c; --text:#e8edf2; --muted:#9aa3ad; --danger:#ff5c5c;
    --head-h:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.5 Inter,system-ui,Segoe UI,Arial;
    display:grid; place-items:start center; min-height:100svh;
  }
  .wrap{width:min(1100px,100%); padding:24px}
  /* Kopfzeile */
  .header-bar{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px; margin-bottom:12px;
  }
  .title{justify-self:start; font-size:22px; margin:0}
  .month{justify-self:center; color:var(--muted); font-weight:600; text-align:center}
  .controls{justify-self:end; display:flex; gap:8px; flex-wrap:wrap}
  .ghost,.primary{
    border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:600;
    border:1px solid rgba(255,255,255,.18); background:transparent; color:var(--text);
  }
  .primary{background:var(--brand); color:#0b0c0f; border:none}
  .primary:hover{background:var(--brand-600)}
  .ghost:focus,.primary:focus{outline:2px solid #fff; outline-offset:1px}

  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px}
  .clock{font-variant-numeric:tabular-nums; color:var(--muted); text-align:center; margin-bottom:12px}

  /* Collapsible Kalender */
  .collapsible{overflow:hidden; max-height:0; transition:max-height .35s ease}
  .collapsible.open{max-height:2000px}
  .calendar-frame{padding:6px; overflow-x:auto}

  /* Raster */
  .grid{display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:14px}
  .day{display:flex; flex-direction:column; gap:10px; min-width:140px}
  .head{
    height:var(--head-h);
    display:grid; grid-auto-rows:min-content; align-content:center; justify-items:center; gap:4px;
    padding:6px 4px; text-align:center;
  }
  .dnum{font-weight:600; line-height:1; display:inline-grid; place-items:center; min-width:3ch}
  .dow{color:var(--muted); font-size:12px; white-space:nowrap}
  .today .dnum{background:rgba(255,255,255,.1); padding:3px 10px; border-radius:999px}

  /* Slots: gleich hohe Zeilen, zentriert */
  .slots{display:grid; grid-auto-rows:44px; gap:10px; position:relative}
  .slot{
    width:100%; height:44px; display:grid; place-items:center; text-align:center;
    border:1px dashed transparent; border-radius:14px; cursor:pointer;
    background:var(--brand); color:#0b0c0f; font-weight:600; font-variant-numeric:tabular-nums;
  }
  .slot:hover{background:var(--brand-600)}
  .slot.selected{outline:2px solid #fff}
  .slot.unavailable{
    background:transparent; border-color:rgba(255,255,255,.20);
    color:var(--muted); text-decoration:line-through; cursor:not-allowed;
  }

  /* Jetzt-Linie */
  .now-line{position:absolute; left:0; right:0; height:2px; background:var(--danger); box-shadow:0 0 0 2px rgba(255,92,92,.15)}
  .now-dot{position:absolute; width:10px; height:10px; border-radius:50%; background:var(--danger); left:-6px; transform:translateY(-4px)}

  /* Formular */
  .form{margin-top:16px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .form .full{grid-column:1 / -1}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input{
    width:100%; padding:11px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.14); background:#0f1215; color:var(--text)
  }
  .row-end{display:flex; gap:12px; justify-content:flex-end; margin-top:6px}
  .hint{color:var(--muted); font-size:13px}
  .ok{color:#3ddc97} .err{color:#ff6b6b}

  /* Responsiv */
  @media (max-width:900px){
    .wrap{padding:16px}
    .slot{height:42px; font-size:14px}
    .slots{gap:8px; grid-auto-rows:42px}
    .controls .ghost{padding:6px 10px; font-size:14px}
  }
  @media (max-width:700px){
    .grid{
      grid-auto-flow:column; grid-auto-columns:86vw;
      overflow-x:auto; gap:10px; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
    }
    .day{scroll-snap-align:start; min-width:0}
    .head{position:sticky; top:0; background:var(--card); z-index:1}
    .dnum{font-size:18px}
    .slots{grid-auto-rows:40px; gap:8px}
    .slot{height:40px; border-radius:12px}
  }
  @media (max-width:480px){
    .grid{grid-auto-columns:92vw}
    .header-bar{grid-template-columns:1fr auto; grid-template-rows:auto auto; row-gap:6px}
    .month{grid-column:1 / -1; justify-self:start}
    .controls{justify-self:end; gap:6px}
    .ghost{padding:6px 8px}
    label{font-size:11px}
    input{padding:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header-bar">
    <h1 class="title">Termine</h1>
    <div class="month" id="monthLabel">—</div>
    <div class="controls">
      <button class="ghost" id="toggleCal" aria-expanded="true">Kalender verbergen</button>
      <button class="ghost" id="prevWeek" aria-label="Vorherige Woche">Zurück</button>
      <button class="ghost" id="nextWeek" aria-label="Nächste Woche">Weiter</button>
      <button class="ghost" id="jumpToday" aria-label="Zu heute springen">Heute</button>
    </div>
  </div>

  <div class="card">
    <div class="clock" id="liveClock">—:—</div>

    <div id="calendar" class="collapsible open" aria-live="polite">
      <div class="calendar-frame">
        <div class="grid" id="weekGrid"></div>
      </div>
    </div>

    <form id="bookForm" class="form" novalidate>
      <div>
        <label for="first">Vorname</label>
        <input id="first" name="first" autocomplete="given-name" required>
      </div>
      <div>
        <label for="last">Nachname</label>
        <input id="last" name="last" autocomplete="family-name" required>
      </div>
      <div>
        <label for="email">E-Mail</label>
        <input id="email" name="email" type="email" autocomplete="email" required>
      </div>
      <div class="full">
        <div class="row-end">
          <button type="submit" class="primary">Bestätigen</button>
        </div>
        <div id="msg" class="hint" role="status" aria-live="polite"></div>
      </div>
    </form>
  </div>
</div>

<script>
(()=>{
  // Konfiguration
  const SLOT_MINUTES = 30;
  const DAY_START = "08:00";
  const DAY_END   = "17:00";
  const LOCALE    = "de-DE";

  // Simulierter Speicher nur im Client
  const booked = new Set(); // Set<number> von Timestamps

  // State
  let weekOffset = 0;
  let selectedTs = null;

  // DOM
  const grid = document.getElementById("weekGrid");
  const monthLabel = document.getElementById("monthLabel");
  const clock = document.getElementById("liveClock");
  const toggleCalBtn = document.getElementById("toggleCal");
  const prevBtn = document.getElementById("prevWeek");
  const nextBtn = document.getElementById("nextWeek");
  const jumpTodayBtn = document.getElementById("jumpToday");
  const calendar = document.getElementById("calendar");
  const form = document.getElementById("bookForm");
  const msg  = document.getElementById("msg");

  // Helpers Zeit
  const toMin = hm => { const [h,m]=hm.split(":").map(Number); return h*60+m; };
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const startOfWeek = d => { const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x; };
  const times = (start,end,step) => {
    const out=[]; const s=toMin(start), e=toMin(end);
    for(let m=s; m<e; m+=step){
      out.push(`${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`);
    }
    return out;
  };
  const tsFor = (date,hm) => { const [h,m]=hm.split(":").map(Number); const x=new Date(date); x.setHours(h,m,0,0); return x.getTime(); };
  const monthText = weekStart => {
    const end = addDays(weekStart,6);
    const same = weekStart.getMonth()===end.getMonth() && weekStart.getFullYear()===end.getFullYear();
    return same
      ? weekStart.toLocaleDateString(LOCALE,{month:'long',year:'numeric'})
      : `${weekStart.toLocaleDateString(LOCALE,{month:'long'})} / ${end.toLocaleDateString(LOCALE,{month:'long',year:'numeric'})}`;
  };

  // UI Events
  toggleCalBtn.onclick = ()=>{
    const open = calendar.classList.toggle("open");
    toggleCalBtn.setAttribute("aria-expanded", String(open));
    toggleCalBtn.textContent = open ? "Kalender verbergen" : "Kalender anzeigen";
  };
  prevBtn.onclick = ()=>{ weekOffset -= 1; renderWeek(); };
  nextBtn.onclick = ()=>{ weekOffset += 1; renderWeek(); };
  jumpTodayBtn.onclick = ()=>{ weekOffset = 0; renderWeek(); focusToday(); };

  // Uhr
  function tickClock(){
    const n = new Date();
    clock.textContent = n.toLocaleString(LOCALE,{weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
  }

  // Render
  function renderWeek(){
    const keepScroll = grid.parentElement.parentElement.scrollLeft; // calendar-frame -> wrapper
    grid.innerHTML = "";

    const nowTs = Date.now();
    const base = startOfWeek(new Date());
    const weekStart = addDays(base, weekOffset*7);
    monthLabel.textContent = monthText(weekStart);
    const tlist = times(DAY_START, DAY_END, SLOT_MINUTES);

    for(let i=0;i<7;i++){
      const day = addDays(weekStart,i);
      const isToday = day.toDateString() === new Date().toDateString();

      const col = document.createElement("div");
      col.className = "day" + (isToday ? " today" : "");

      const head = document.createElement("div");
      head.className = "head";
      head.innerHTML = `
        <div class="dnum">${day.toLocaleDateString(LOCALE,{day:'2-digit'})}</div>
        <div class="dow">${day.toLocaleDateString(LOCALE,{weekday:'short'})}${isToday?' • heute':''}</div>`;
      col.appendChild(head);

      const list = document.createElement("div");
      list.className = "slots";
      col.appendChild(list);

      for(const t of tlist){
        const ts = tsFor(day,t);
        const when = new Date(ts);
        const inPast = ts < nowTs;
        const isBooked = booked.has(ts);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = t;
        btn.className = "slot";
        if(selectedTs === ts) btn.classList.add("selected");
        if(inPast || isBooked){
          btn.disabled = true;
          btn.classList.add("unavailable");
        }
        btn.onclick = ()=>{
          document.querySelectorAll(".slot.selected").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedTs = ts;
          msg.innerHTML = `Ausgewählt: <span class="ok">${when.toLocaleString(LOCALE,{weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}</span>`;
        };
        list.appendChild(btn);
      }

      if(isToday) requestAnimationFrame(()=>positionNowLine(list));
      grid.appendChild(col);
    }

    grid.parentElement.parentElement.scrollLeft = keepScroll;
  }

  // Jetzt-Linie exakt zwischen Slots
  function positionNowLine(slotsEl){
    const startM = toMin(DAY_START), endM = toMin(DAY_END);
    const now = new Date(); const nowM = now.getHours()*60 + now.getMinutes();
    if(nowM < startM || nowM > endM){ removeNow(slotsEl); return; }

    const frac = (nowM - startM) / (endM - startM);
    const y = frac * (slotsEl.scrollHeight - 2);

    let line = slotsEl.querySelector(".now-line");
    let dot  = slotsEl.querySelector(".now-dot");
    if(!line){ line=document.createElement("div"); line.className="now-line"; slotsEl.appendChild(line); }
    if(!dot){  dot =document.createElement("div");  dot.className="now-dot";  slotsEl.appendChild(dot); }
    line.style.top = `${y}px`;
    dot.style.top  = `${y}px`;
  }
  function removeNow(el){ el.querySelectorAll(".now-line,.now-dot").forEach(n=>n.remove()); }
  function heartbeat(){ tickClock(); renderWeek(); }

  // Heute fokussieren (mobil hilfreich)
  function focusToday(){
    const todayCol = document.querySelector(".day.today");
    if(!todayCol) return;
    todayCol.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
  }

  // Formular
  form.addEventListener("submit",(e)=>{
    e.preventDefault();
    msg.textContent = "";
    const first = form.first.value.trim();
    const last  = form.last.value.trim();
    const email = form.email.value.trim();
    if(selectedTs == null){ msg.innerHTML = '<span class="err">Bitte Termin wählen.</span>'; return; }
    if(!first || !last){ msg.innerHTML = '<span class="err">Vor- und Nachname angeben.</span>'; return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.innerHTML = '<span class="err">E-Mail ungültig.</span>'; return; }

    booked.add(selectedTs);
    renderWeek();
    msg.innerHTML = '<span class="ok">Vorgemerkt. Bestätigung folgt per E-Mail.</span>';
    form.reset();
  });

  // Init
  tickClock(); renderWeek(); focusToday();
  setInterval(heartbeat, 30000);
  setInterval(tickClock, 1000);
  addEventListener("resize", ()=>{
    const todaySlots = document.querySelector(".day.today .slots");
    if(todaySlots) positionNowLine(todaySlots);
  });
})();
</script>
</body>
</html>
